# Risk Profile: Story 1.2 - 混合匹配策略

Date: 2025-11-10
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 2
- High Risks: 2
- Medium Risks: 3
- Low Risks: 1
- Risk Score: 54/100 (中等风险)

## Critical Risks Requiring Immediate Attention

### 1. BUILD-001: 缺少 FuzzySharp 依赖

**Score: 9 (Critical)**

**Probability**: High (3) - 代码已使用该库但未添加依赖
**Impact**: High (3) - 导致编译失败，完全阻塞开发和测试

**Description:**
代码中使用了 `FuzzySharp.Fuzz.Ratio()` 方法，但 `GameHelper.Core.csproj` 中没有添加 FuzzySharp NuGet 包引用。这导致代码无法编译。

**Affected Components:**
- `GameHelper.Core/Services/GameAutomationService.cs` (MatchByMetadata 方法)
- `GameHelper.Core/GameHelper.Core.csproj`

**Detection Method:**
代码审查发现 using 语句引用了 FuzzySharp，但项目文件中无对应包引用。

**Mitigation:**
- **Strategy**: Preventive
- **Actions**:
  1. 在 `GameHelper.Core.csproj` 中添加 `<PackageReference Include="FuzzySharp" Version="2.0.2" />`
  2. 运行 `dotnet restore` 恢复包
  3. 运行 `dotnet build` 验证编译成功
  4. 更新 `docs/architecture/tech-stack.md` 记录依赖版本
- **Testing Requirements**:
  - 验证编译成功
  - 验证 FuzzySharp API 可用
- **Residual Risk**: Minimal - 添加依赖后风险完全消除
- **Owner**: dev
- **Timeline**: 立即修复（< 10 分钟）

---

### 2. TEST-001: 测试 API 不匹配

**Score: 9 (Critical)**

**Probability**: High (3) - 所有现有测试都使用旧 API
**Impact**: High (3) - 所有测试无法运行，无法验证功能

**Description:**
现有测试中的 `FakeMonitor` 使用 `event Action<string>?` 签名，但实际实现已更新为 `event Action<ProcessEventInfo>?`。这导致测试无法编译或运行。

**Affected Components:**
- `GameHelper.Tests/GameAutomationServiceTests.cs` (所有测试)
- `GameHelper.Core/Abstractions/IProcessMonitor.cs` (接口定义)

**Detection Method:**
代码审查发现测试 fakes 与实际接口不匹配。

**Mitigation:**
- **Strategy**: Corrective
- **Actions**:
  1. 更新 `IProcessMonitor` 接口定义明确使用 `ProcessEventInfo`
  2. 更新 `FakeMonitor` 类：
     ```csharp
     public event Action<ProcessEventInfo>? ProcessStarted;
     public event Action<ProcessEventInfo>? ProcessStopped;
     public void RaiseStart(ProcessEventInfo info) => ProcessStarted?.Invoke(info);
     public void RaiseStop(ProcessEventInfo info) => ProcessStopped?.Invoke(info);
     ```
  3. 更新所有测试用例以传递 `ProcessEventInfo` 而非 `string`
  4. 运行 `dotnet test` 验证测试可以执行
- **Testing Requirements**:
  - 所有现有测试必须能够编译和运行
  - 至少保持现有测试的通过率
- **Residual Risk**: Low - 更新后测试可正常运行
- **Owner**: dev
- **Timeline**: 立即修复（1-2 小时）

---

## Risk Distribution

### By Category

- Build/Compilation: 1 risk (1 critical)
- Testing: 3 risks (1 critical, 2 high)
- Performance: 2 risks (1 medium, 1 low)
- Data: 1 risk (1 medium)
- Operational: 1 risk (1 medium)

### By Component

- GameAutomationService: 5 risks
- Test Infrastructure: 2 risks
- Project Configuration: 1 risk

## Detailed Risk Register

| Risk ID | Category | Description | Probability | Impact | Score | Priority |
|---------|----------|-------------|-------------|--------|-------|----------|
| BUILD-001 | Build | 缺少 FuzzySharp 依赖 | High (3) | High (3) | 9 | Critical |
| TEST-001 | Testing | 测试 API 不匹配 | High (3) | High (3) | 9 | Critical |
| TEST-002 | Testing | 缺少 L1/L2 匹配测试 | High (3) | Medium (2) | 6 | High |
| TEST-003 | Testing | 缺少模糊匹配边界测试 | Medium (2) | High (3) | 6 | High |
| PERF-001 | Performance | L2 匹配文件 I/O 性能 | Medium (2) | Medium (2) | 4 | Medium |
| DATA-001 | Data | 配置分组逻辑错误 | Low (1) | High (3) | 3 | Medium |
| OPS-001 | Operational | 缺少监控和日志分析 | Medium (2) | Low (1) | 2 | Medium |
| PERF-002 | Performance | 模糊匹配计算性能 | Low (1) | Low (1) | 1 | Low |

## High Priority Risks (Score ≥ 6)

### TEST-002: 缺少 L1/L2 匹配测试

**Score: 6 (High)**

**Probability**: High (3) - 完全缺少测试覆盖
**Impact**: Medium (2) - 无法验证核心功能，但代码逻辑清晰

**Description:**
完全缺少 L1 路径匹配和 L2 元数据/模糊匹配的测试覆盖。无法验证：
- 配置分组逻辑
- L1 路径匹配（精确、不区分大小写）
- L2 回退逻辑
- ProductName 获取和回退

**Mitigation:**
- **Strategy**: Preventive
- **Actions**:
  1. 添加配置分组测试（4 个场景）
  2. 添加 L1 路径匹配测试（4 个场景）
  3. 添加 L2 流程控制测试（2 个场景）
  4. 添加 ProductName 测试（3 个场景）
- **Testing Requirements**:
  - 参见 `test-design-20251110.md` 详细测试场景
- **Residual Risk**: Low - 添加测试后可验证功能正确性
- **Owner**: dev
- **Timeline**: 发布前修复（2-3 小时）

---

### TEST-003: 缺少模糊匹配边界测试

**Score: 6 (High)**

**Probability**: Medium (2) - 模糊匹配逻辑相对复杂
**Impact**: High (3) - 阈值不当可能导致误匹配或漏匹配

**Description:**
缺少模糊匹配阈值边界测试。无法验证：
- 分数 > 80 时匹配成功
- 分数 = 80 时匹配成功（边界）
- 分数 < 80 时匹配失败
- 多个候选时选择最高分

**Mitigation:**
- **Strategy**: Preventive
- **Actions**:
  1. 添加阈值边界测试（3 个场景）
  2. 添加多候选选择测试（1 个场景）
  3. 添加空配置列表测试（1 个场景）
- **Testing Requirements**:
  - 需要找到恰好得分 80 的字符串对
  - 验证边界条件处理正确
- **Residual Risk**: Low - 测试覆盖后可确保阈值正确
- **Owner**: dev
- **Timeline**: 发布前修复（1-2 小时）

---

## Medium Priority Risks (Score = 4)

### PERF-001: L2 匹配文件 I/O 性能

**Score: 4 (Medium)**

**Probability**: Medium (2) - L1 失败时必然触发
**Impact**: Medium (2) - 可能导致轻微延迟

**Description:**
每次 L1 匹配失败时，L2 匹配会调用 `FileVersionInfo.GetVersionInfo(exePath)` 进行文件 I/O 操作。如果进程频繁启动，可能累积显著延迟。

**Mitigation:**
- **Strategy**: Detective + Preventive
- **Actions**:
  1. 添加性能基准测试验证实际影响
  2. 如果影响显著，实现 ProductName 缓存
  3. 添加性能监控日志
- **Testing Requirements**:
  - 基准测试：100 次 L2 匹配的总时间
  - 目标：< 100ms 总延迟
- **Residual Risk**: Low - 当前场景（用户手动启动游戏）影响可忽略
- **Owner**: dev
- **Timeline**: 未来优化（如果性能测试显示问题）

---

### DATA-001: 配置分组逻辑错误

**Score: 3 (Medium)**

**Probability**: Low (1) - 代码逻辑清晰简单
**Impact**: High (3) - 错误分组导致匹配失败

**Description:**
如果配置分组逻辑有错误（例如路径优先策略未正确实现），可能导致配置被分到错误的列表，从而导致匹配失败。

**Mitigation:**
- **Strategy**: Preventive
- **Actions**:
  1. 添加配置分组测试（4 个场景）
  2. 验证路径优先策略
  3. 验证禁用配置被忽略
- **Testing Requirements**:
  - 测试所有分组场景
  - 验证边界条件
- **Residual Risk**: Minimal - 测试覆盖后风险极低
- **Owner**: dev
- **Timeline**: 发布前修复（30 分钟）

---

### OPS-001: 缺少监控和日志分析

**Score: 2 (Medium)**

**Probability**: Medium (2) - 生产环境必然需要
**Impact**: Low (1) - 不影响功能，但影响故障排查

**Description:**
缺少以下监控和日志分析能力：
- L1 匹配成功率
- L2 匹配成功率
- 平均匹配时间
- FileVersionInfo 调用频率
- 模糊匹配分数分布

**Mitigation:**
- **Strategy**: Detective
- **Actions**:
  1. 添加结构化日志记录关键指标
  2. 考虑添加性能计数器
  3. 添加故障排查指南文档
- **Testing Requirements**:
  - 验证日志包含足够信息
  - 验证日志格式便于分析
- **Residual Risk**: Low - 现有日志已较详细
- **Owner**: dev
- **Timeline**: 未来改进（非阻塞）

---

## Low Priority Risks (Score ≤ 2)

### PERF-002: 模糊匹配计算性能

**Score: 1 (Low)**

**Probability**: Low (1) - 配置数量预期 < 50
**Impact**: Low (1) - 当前规模影响可忽略

**Description:**
模糊匹配对每个 NameBased 配置执行 `Fuzz.Ratio()` 计算，算法复杂度 O(n*m)。如果配置数量很大（> 100），可能需要优化。

**Mitigation:**
- **Strategy**: Preventive (未来)
- **Actions**:
  1. 监控配置数量增长
  2. 如果配置 > 100，考虑优化：
     - 使用 FuzzySharp 索引功能
     - 预过滤候选（首字母匹配）
     - 并行计算
- **Testing Requirements**:
  - 性能基准测试（100 个配置）
- **Residual Risk**: Minimal - 当前规模无影响
- **Owner**: dev
- **Timeline**: 未来优化（仅当配置数量增长时）

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (必须在发布前完成)

1. **BUILD-001 验证**
   - 添加依赖后验证编译成功
   - 验证 FuzzySharp API 可用

2. **TEST-001 验证**
   - 更新接口和测试后验证测试可运行
   - 验证现有测试通过

### Priority 2: High Risk Tests (发布前强烈建议)

1. **TEST-002 覆盖**
   - 配置分组测试
   - L1 路径匹配测试
   - L2 流程控制测试
   - ProductName 测试

2. **TEST-003 覆盖**
   - 模糊匹配阈值边界测试
   - 多候选选择测试

### Priority 3: Medium Risk Tests (建议但可延后)

1. **PERF-001 验证**
   - 性能基准测试
   - 如果有问题，实现缓存

2. **DATA-001 验证**
   - 配置分组边界条件测试

3. **OPS-001 改进**
   - 添加监控指标
   - 完善日志记录

## Risk Acceptance Criteria

### Must Fix Before Production

- ✅ BUILD-001: 添加 FuzzySharp 依赖
- ✅ TEST-001: 更新测试 API
- ✅ TEST-002: 添加 L1/L2 匹配测试
- ✅ TEST-003: 添加模糊匹配边界测试

### Can Deploy with Mitigation

- ⚠️ PERF-001: 性能影响可接受，添加监控
- ⚠️ DATA-001: 代码逻辑清晰，风险低
- ⚠️ OPS-001: 现有日志已足够，可延后改进

### Accepted Risks

- ✓ PERF-002: 配置数量预期 < 50，性能影响可忽略

## Monitoring Requirements

Post-deployment monitoring for:

### Performance Metrics
- L1 匹配平均时间
- L2 匹配平均时间
- FileVersionInfo 调用频率
- 模糊匹配计算时间

### Functional Metrics
- L1 匹配成功率
- L2 匹配成功率
- 匹配失败率
- 配置分组统计

### Error Metrics
- FileVersionInfo 异常频率
- 路径规范化失败频率
- 未匹配进程数量

## Risk Review Triggers

Review and update risk profile when:

- 配置数量显著增长（> 50）
- 性能问题报告
- 匹配失败率异常
- 新的匹配策略需求
- 依赖库版本升级

## Overall Risk Assessment

**Current Risk Level: MEDIUM-HIGH**

**Primary Concerns:**
1. 编译失败阻塞所有开发（Critical）
2. 测试无法运行阻塞验证（Critical）
3. 缺少核心功能测试（High）

**Recommended Actions:**
1. 立即修复 BUILD-001 和 TEST-001（< 2 小时）
2. 发布前添加完整测试覆盖（2-4 小时）
3. 监控生产环境性能指标
4. 根据实际使用情况优化性能

**Risk Reduction Path:**
- 修复 Critical 风险后：Risk Score 提升至 74/100 (Low-Medium)
- 添加完整测试后：Risk Score 提升至 88/100 (Low)
- 实施性能优化后：Risk Score 提升至 95/100 (Minimal)
