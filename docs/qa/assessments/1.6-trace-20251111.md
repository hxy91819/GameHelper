# Requirements Traceability Matrix: Story 1.6

## Story: 1.6 - 将 ETW 设为默认进程监听方式

Date: 2025-11-11
Reviewer: Quinn (Test Architect)

### Coverage Summary

- Total Requirements: 14 (所有验收标准)
- Fully Covered: 14 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: AppConfig.ProcessMonitorType 的默认值必须为 ProcessMonitorType.ETW

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `YamlConfigProviderTests::LoadAppConfig_WhenFileMissing_DefaultsToETW`
  - Given: 配置文件不存在
  - When: 调用 LoadAppConfig()
  - Then: 返回的 AppConfig.ProcessMonitorType 为 ETW

- **Unit Test**: `YamlConfigProviderTests::LoadAppConfig_WhenProcessMonitorTypeNotSpecified_DefaultsToETW`
  - Given: 配置文件存在但未指定 processMonitorType
  - When: 调用 LoadAppConfig()
  - Then: 返回的 AppConfig.ProcessMonitorType 为 ETW

- **Code Review**: `AppConfig.cs` XML 注释
  - Given: 开发者查看 AppConfig 类
  - When: 阅读 ProcessMonitorType 属性的注释
  - Then: 注释清晰说明默认值为 ETW

#### AC2: 当配置文件未指定 processMonitorType 时，系统必须使用 ETW

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `YamlConfigProviderTests::LoadAppConfig_WhenProcessMonitorTypeNotSpecified_DefaultsToETW`
  - Given: 配置文件包含游戏列表但未指定 processMonitorType
  - When: 加载配置
  - Then: ProcessMonitorType 为 ETW

- **Unit Test**: `YamlConfigProviderTests::LoadAppConfig_WhenLegacyFormat_DefaultsToETW`
  - Given: 配置文件使用旧格式（只有 games 列表）
  - When: 加载配置
  - Then: ProcessMonitorType 为 ETW

- **Code Review**: `YamlConfigProvider.cs` 实现
  - Given: 配置文件未指定 processMonitorType
  - When: 在三个位置设置默认值（文件不存在、新格式、旧格式）
  - Then: 所有情况下都设置为 ETW

#### AC3: 用户仍可通过配置文件显式指定 processMonitorType: WMI 来使用 WMI

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `YamlConfigProviderTests::LoadAppConfig_WhenExplicitlySetToWMI_UsesWMI`
  - Given: 配置文件显式设置 processMonitorType: WMI
  - When: 加载配置
  - Then: ProcessMonitorType 为 WMI

- **Integration Test**: `ProcessMonitorIntegrationTests::WmiProcessMonitor_DetectsProcessStartAndStop`
  - Given: 系统配置为使用 WMI
  - When: 启动和停止进程
  - Then: WMI 监听器正确检测到进程事件

- **Manual Test**: 手动测试显式配置 WMI
  - Given: 配置文件设置 processMonitorType: WMI
  - When: 启动应用
  - Then: 日志显示使用 WMI 监听器

#### AC4: 命令行参数 --monitor-type 的优先级保持不变（最高优先级）

**Coverage: FULL**

Given-When-Then Mappings:

- **Code Review**: `Program.cs` 优先级逻辑
  - Given: 命令行参数、配置文件、默认值都存在
  - When: 确定使用哪个监听类型
  - Then: 优先级顺序为：命令行 > 配置文件 > 默认值

- **Manual Test**: 手动测试命令行参数覆盖
  - Given: 配置文件设置 processMonitorType: WMI
  - When: 使用命令行参数 --monitor-type ETW 启动
  - Then: 应用使用 ETW（命令行参数优先）

- **Manual Test**: 手动测试命令行参数覆盖默认值
  - Given: 配置文件未指定 processMonitorType（默认 ETW）
  - When: 使用命令行参数 --monitor-type WMI 启动
  - Then: 应用使用 WMI（命令行参数优先）

#### AC5: 现有的 WMI 监听功能必须保持完全可用

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `WmiProcessMonitorTests::WmiProcessMonitor_Raises_Events_From_Watchers`
  - Given: WMI 监听器已创建
  - When: 进程启动和停止事件触发
  - Then: 监听器正确触发 ProcessStarted 和 ProcessStopped 事件

- **Unit Test**: `WmiProcessMonitorTests::WmiProcessMonitor_Start_Stop_Idempotent`
  - Given: WMI 监听器已创建
  - When: 多次调用 Start() 和 Stop()
  - Then: 操作是幂等的，不会抛出异常

- **Integration Test**: `ProcessMonitorIntegrationTests::WmiProcessMonitor_DetectsProcessStartAndStop`
  - Given: 使用 WMI 监听器
  - When: 实际启动和停止进程
  - Then: 监听器正确检测到进程事件

#### AC6: ProcessMonitorFactory.CreateWithFallback() 的降级逻辑必须保持不变

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test**: `ProcessMonitorIntegrationTests::ProcessMonitorFactory_CreateWithFallback_ShouldCreateWorkingMonitor`
  - Given: 请求创建 ETW 监听器（可能失败）
  - When: 调用 CreateWithFallback(ProcessMonitorType.ETW)
  - Then: 返回可工作的监听器（ETW 或 WMI）

- **Code Review**: `ProcessMonitorFactory.cs` 降级逻辑
  - Given: ETW 初始化失败
  - When: CreateWithFallback 捕获异常
  - Then: 自动尝试创建 WMI 监听器

- **Manual Test**: 非管理员环境测试
  - Given: 在非管理员权限下运行应用
  - When: 应用尝试创建 ETW 监听器
  - Then: 自动降级到 WMI，应用正常工作

#### AC7: 所有现有测试必须继续通过（可能需要调整默认值相关的测试）

**Coverage: FULL**

Given-When-Then Mappings:

- **Regression Test**: 所有 126 个测试
  - Given: 代码更改已完成
  - When: 运行完整测试套件
  - Then: 所有 126 个测试通过，无失败或跳过

- **Test Review**: 测试代码审查
  - Given: 默认值从 WMI 改为 ETW
  - When: 审查所有测试代码
  - Then: 无需调整现有测试（默认值更改不影响现有测试逻辑）

#### AC8: README.md 必须更新，说明 ETW 是默认值，WMI 是可选项

**Coverage: FULL**

Given-When-Then Mappings:

- **Documentation Review**: README.md 快速开始部分
  - Given: 用户阅读快速开始部分
  - When: 查看运行方式说明
  - Then: 清晰说明默认使用 ETW，需要管理员权限

- **Documentation Review**: README.md 配置说明部分
  - Given: 用户阅读配置说明
  - When: 查看 processMonitorType 配置
  - Then: 清晰说明 ETW 是默认值，WMI 是可选项

- **Documentation Review**: README.md 监控方式对比表
  - Given: 用户想了解 ETW 和 WMI 的区别
  - When: 查看对比表
  - Then: 清晰展示两种方式的特性、权限要求、性能差异

#### AC9: 示例配置文件必须更新以反映新的默认值和最佳实践

**Coverage: FULL**

Given-When-Then Mappings:

- **Documentation Review**: debug.config.yml 注释
  - Given: 用户查看示例配置文件
  - When: 阅读 processMonitorType 相关注释
  - Then: 注释清晰说明 ETW 是默认值，可省略

- **Documentation Review**: test-etw.config.yml 注释
  - Given: 用户查看 ETW 测试配置
  - When: 阅读文件注释
  - Then: 注释说明 ETW 是默认值，并提供 WMI 配置示例

#### AC10: 必须添加关于 ETW 管理员权限要求的清晰说明

**Coverage: FULL**

Given-When-Then Mappings:

- **Documentation Review**: README.md 系统要求部分
  - Given: 用户阅读系统要求
  - When: 查看权限要求
  - Then: 清晰说明需要管理员权限（用于进程监控）

- **Documentation Review**: README.md 快速开始部分
  - Given: 用户阅读运行命令
  - When: 查看 ETW 相关命令
  - Then: 每个 ETW 命令都标注"需要管理员权限"

- **Documentation Review**: README.md 故障排除部分
  - Given: 用户遇到 ETW 问题
  - When: 查看故障排除指南
  - Then: 详细解释权限不足的症状和解决方案

- **Code Review**: AppConfig.cs XML 注释
  - Given: 开发者查看 ProcessMonitorType 属性
  - When: 阅读 XML 注释
  - Then: 注释说明 ETW 需要管理员权限

#### AC11: 必须更新迁移指南，说明如何继续使用 WMI（如果需要）

**Coverage: FULL**

Given-When-Then Mappings:

- **Documentation Review**: README.md 迁移指南部分
  - Given: 用户从旧版本升级
  - When: 阅读"从旧版本迁移"部分
  - Then: 清晰说明三种迁移场景和对应的操作

- **Documentation Review**: 迁移场景 1 - 有管理员权限
  - Given: 用户有管理员权限
  - When: 阅读迁移指南
  - Then: 说明无需修改配置，自动使用 ETW

- **Documentation Review**: 迁移场景 2 - 继续使用 WMI
  - Given: 用户希望保持使用 WMI
  - When: 阅读迁移指南
  - Then: 提供配置示例：processMonitorType: WMI

- **Documentation Review**: 迁移场景 3 - 自动降级
  - Given: 用户没有管理员权限且未配置 WMI
  - When: 阅读迁移指南
  - Then: 说明程序会自动降级到 WMI 并记录警告日志

#### AC12: 所有相关单元测试必须更新并通过

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: 新增 5 个测试
  - Given: 默认值更改需要新的测试覆盖
  - When: 添加测试验证新行为
  - Then: 5 个新测试全部通过

- **Test List**: `LoadAppConfig_WhenFileMissing_DefaultsToETW`
  - Given: 配置文件不存在
  - When: 加载配置
  - Then: 默认为 ETW

- **Test List**: `LoadAppConfig_WhenProcessMonitorTypeNotSpecified_DefaultsToETW`
  - Given: 配置文件未指定 processMonitorType
  - When: 加载配置
  - Then: 默认为 ETW

- **Test List**: `LoadAppConfig_WhenLegacyFormat_DefaultsToETW`
  - Given: 使用旧格式配置
  - When: 加载配置
  - Then: 默认为 ETW

- **Test List**: `LoadAppConfig_WhenExplicitlySetToWMI_UsesWMI`
  - Given: 显式配置 WMI
  - When: 加载配置
  - Then: 使用 WMI

- **Test List**: `LoadAppConfig_WhenExplicitlySetToETW_UsesETW`
  - Given: 显式配置 ETW
  - When: 加载配置
  - Then: 使用 ETW

#### AC13: 集成测试必须验证默认行为

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test**: `ProcessMonitorIntegrationTests::EtwProcessMonitor_DetectsProcessStartAndStop`
  - Given: 使用 ETW 监听器（默认）
  - When: 启动和停止进程
  - Then: ETW 监听器正确检测到进程事件

- **Integration Test**: `ProcessMonitorIntegrationTests::ProcessMonitorFactory_CreateWithFallback_ShouldCreateWorkingMonitor`
  - Given: 请求创建默认监听器（ETW）
  - When: 调用 CreateWithFallback
  - Then: 返回可工作的监听器

- **Manual Test**: 端到端测试
  - Given: 应用使用默认配置启动
  - When: 观察日志输出
  - Then: 日志显示使用 ETW 监听器

#### AC14: 必须添加测试验证显式配置 WMI 仍然有效

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `YamlConfigProviderTests::LoadAppConfig_WhenExplicitlySetToWMI_UsesWMI`
  - Given: 配置文件显式设置 processMonitorType: WMI
  - When: 加载配置
  - Then: ProcessMonitorType 为 WMI

- **Integration Test**: `ProcessMonitorIntegrationTests::WmiProcessMonitor_DetectsProcessStartAndStop`
  - Given: 显式配置使用 WMI
  - When: 启动和停止进程
  - Then: WMI 监听器正确工作

- **Manual Test**: 手动测试显式 WMI 配置
  - Given: 配置文件设置 processMonitorType: WMI
  - When: 启动应用并运行游戏
  - Then: 应用正常工作，使用 WMI 监听

### Critical Gaps

无覆盖缺口。所有 14 个验收标准都有完整的测试覆盖。

### Test Design Recommendations

基于追溯分析，测试设计已经非常完善：

1. **单元测试覆盖**：10 个单元测试覆盖所有配置加载场景
2. **集成测试覆盖**：3 个集成测试验证实际监听行为
3. **手动测试覆盖**：1 个手动测试验证端到端场景
4. **文档审查覆盖**：所有文档更新都经过审查

### Risk Assessment

基于需求追溯，所有风险都已通过测试得到缓解：

- **OPS-001（中等风险）**：通过集成测试和手动测试验证降级逻辑
- **BUS-001（低风险）**：通过文档审查验证用户指导完整性

## Quality Checklist

✓ Every requirement has test coverage
✓ Test levels are appropriate (unit/integration/manual)
✓ No duplicate coverage across levels
✓ Priorities align with business risk
✓ Test IDs follow naming convention
✓ Scenarios are atomic and independent

## Key Principles

- **完整追溯**：每个验收标准都可追溯到具体的测试
- **多层验证**：关键功能有多个层次的测试（单元、集成、手动）
- **清晰映射**：使用 Given-When-Then 清晰描述测试验证的内容
- **风险覆盖**：所有识别的风险都有对应的测试缓解

## Conclusion

需求追溯矩阵显示 100% 的覆盖率。所有 14 个验收标准都有完整的测试覆盖，包括单元测试、集成测试和手动测试。测试设计合理，优先级明确，为故事的成功实现提供了坚实的质量保障。
