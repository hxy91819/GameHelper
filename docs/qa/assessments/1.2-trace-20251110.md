# Requirements Traceability Matrix: Story 1.2

## Story: 1.2 - 更新核心匹配逻辑（混合策略）

### Coverage Summary

- Total Requirements: 7 (AC1-AC7)
- Fully Covered: 0 (0%)
- Partially Covered: 0 (0%)
- Not Covered: 7 (100%)

**状态：严重不足** - 所有验收标准都缺少测试覆盖

### Requirement Mappings

#### AC1: 配置分组逻辑

**Coverage: NONE**

**Requirement:**
服务启动时，`GameConfig` 列表必须被分成 `PathBasedConfigs` 和 `NameBasedConfigs` 两个列表。

**Code Implementation:**
- ✅ 已实现：`GameAutomationService.Start()` 方法
- ✅ 代码位置：`GameHelper.Core/Services/GameAutomationService.cs` 行 60-90

**Test Mappings:**
- ❌ **无测试覆盖**

**Required Tests (Given-When-Then):**

1. **配置有路径时分组到 PathBased**
   - Given: 配置包含 ExecutablePath
   - When: 调用 Start() 方法
   - Then: 配置被添加到 PathBased 列表

2. **配置仅有名称时分组到 NameBased**
   - Given: 配置仅包含 ExecutableName（无 ExecutablePath）
   - When: 调用 Start() 方法
   - Then: 配置被添加到 NameBased 列表

3. **配置同时有路径和名称时优先路径**
   - Given: 配置同时包含 ExecutablePath 和 ExecutableName
   - When: 调用 Start() 方法
   - Then: 配置被添加到 PathBased 列表（路径优先）

4. **禁用的配置不被分组**
   - Given: 配置的 IsEnabled = false
   - When: 调用 Start() 方法
   - Then: 配置不被添加到任何列表

---

#### AC2: L1 路径匹配

**Coverage: NONE**

**Requirement:**
当进程事件到达时，必须*首先*尝试将其 `exePath` 与 `PathBasedConfigs` 列表进行精确（不区分大小写）匹配。

**Code Implementation:**
- ✅ 已实现：`MatchByPath()` 方法
- ✅ 代码位置：`GameHelper.Core/Services/GameAutomationService.cs` 行 240-253

**Test Mappings:**
- ❌ **无测试覆盖**

**Required Tests (Given-When-Then):**

1. **精确路径匹配成功**
   - Given: PathBased 配置包含路径 "C:\Games\game.exe"
   - When: 进程启动事件携带相同路径
   - Then: 匹配成功，返回该配置

2. **不区分大小写匹配**
   - Given: PathBased 配置包含路径 "C:\Games\game.exe"
   - When: 进程启动事件携带路径 "c:\games\GAME.EXE"
   - Then: 匹配成功（不区分大小写）

3. **路径不匹配返回 null**
   - Given: PathBased 配置包含路径 "C:\Games\game.exe"
   - When: 进程启动事件携带不同路径 "C:\Other\other.exe"
   - Then: 匹配失败，返回 null

4. **路径规范化处理**
   - Given: PathBased 配置包含规范化路径
   - When: 进程启动事件携带带尾部斜杠的路径
   - Then: 规范化后匹配成功

---

#### AC3: L2 回退匹配

**Coverage: NONE**

**Requirement:**
仅当第 1 级匹配失败时，才尝试第 2 级。

**Code Implementation:**
- ✅ 已实现：`OnProcessStarted()` 方法中的流程控制
- ✅ 代码位置：`GameHelper.Core/Services/GameAutomationService.cs` 行 130-138

**Test Mappings:**
- ❌ **无测试覆盖**

**Required Tests (Given-When-Then):**

1. **L1 成功时不执行 L2**
   - Given: 配置同时存在于 PathBased 和 NameBased
   - When: 进程启动事件匹配 PathBased 配置
   - Then: 使用 PathBased 配置，不执行 L2 匹配

2. **L1 失败时执行 L2**
   - Given: 配置仅存在于 NameBased
   - When: 进程启动事件无法匹配 PathBased
   - Then: 执行 L2 模糊匹配

---

#### AC4: ProductName 获取

**Coverage: NONE**

**Requirement:**
第 2 级必须尝试从 `exePath` 获取 `FileVersionInfo.ProductName`。

**Code Implementation:**
- ✅ 已实现：`TryGetProductName()` 方法
- ✅ 代码位置：`GameHelper.Core/Services/GameAutomationService.cs` 行 470-486

**Test Mappings:**
- ❌ **无测试覆盖**

**Required Tests (Given-When-Then):**

1. **ProductName 可用时使用 ProductName**
   - Given: 可执行文件包含有效的 ProductName 元数据
   - When: 调用 TryGetProductName()
   - Then: 返回 ProductName 用于模糊匹配

2. **ProductName 不可用时回退到 exeName**
   - Given: 可执行文件不包含 ProductName 元数据
   - When: 调用 TryGetProductName() 返回 null
   - Then: 使用 ExecutableName 进行模糊匹配

3. **FileVersionInfo 异常时回退**
   - Given: 文件路径无效或文件不存在
   - When: FileVersionInfo.GetVersionInfo() 抛出异常
   - Then: 捕获异常，返回 null，回退到 exeName

---

#### AC5 & AC6: 模糊匹配

**Coverage: NONE**

**Requirement:**
第 2 级必须使用 `FuzzySharp` 将 `ProductName`（或 `exeName`）与 `NameBasedConfigs` 列表中的 `config.ExecutableName` 进行比较。如果模糊匹配（例如 `Fuzz.Ratio` > 80）成功，则匹配该配置。

**Code Implementation:**
- ✅ 已实现：`MatchByMetadata()` 方法
- ✅ 代码位置：`GameHelper.Core/Services/GameAutomationService.cs` 行 255-295
- ⚠️ **依赖缺失**：FuzzySharp 包未添加到项目

**Test Mappings:**
- ❌ **无测试覆盖**

**Required Tests (Given-When-Then):**

1. **模糊匹配分数 > 80 时成功**
   - Given: NameBased 配置 ExecutableName = "The Witcher 3"
   - When: ProductName = "Witcher3"，Fuzz.Ratio 计算得分 > 80
   - Then: 匹配成功，返回该配置

2. **模糊匹配分数 = 80 时成功**
   - Given: NameBased 配置和搜索字符串
   - When: Fuzz.Ratio 计算得分恰好 = 80
   - Then: 匹配成功（边界条件）

3. **模糊匹配分数 < 80 时失败**
   - Given: NameBased 配置 ExecutableName = "completely different"
   - When: ProductName = "game"，Fuzz.Ratio 计算得分 < 80
   - Then: 匹配失败，返回 null

4. **多个候选时选择最高分**
   - Given: 多个 NameBased 配置都得分 > 80
   - When: 执行模糊匹配
   - Then: 返回得分最高的配置

5. **无 NameBased 配置时返回 null**
   - Given: NameBased 配置列表为空
   - When: 执行 L2 匹配
   - Then: 返回 null

---

#### AC7: 移除旧逻辑

**Coverage: PARTIAL (代码审查)**

**Requirement:**
所有旧的（非元数据/模糊）前缀或词干匹配逻辑必须被移除。

**Code Implementation:**
- ✅ 已移除：`Stem()` 方法
- ✅ 已移除：`BuildEnabledStemIndex()` 方法
- ✅ 已移除：`FindEnabledStemCandidates()` 和 `FindActiveStemCandidates()` 方法
- ✅ 已移除：`_enabledStemIndex` 和 `_activeByStem` 字段
- ✅ 已移除：`TrackActiveStem()`, `RemoveActiveStem()`, `StemMatches()` 方法

**Verification:**
- ✅ 代码审查确认：所有旧逻辑已完全移除
- ❌ **缺少回归测试**：无测试验证旧逻辑不再工作

**Required Tests (Given-When-Then):**

1. **旧词干匹配不再工作**
   - Given: 配置使用旧的词干匹配格式
   - When: 进程启动事件到达
   - Then: 不使用词干匹配，仅使用新的 L1/L2 策略

---

## Critical Gaps

### 1. 编译失败（阻塞所有测试）

**Gap**: FuzzySharp NuGet 包未添加
**Impact**: 代码无法编译，所有测试无法运行
**Priority**: P0 - 必须立即修复
**Action**: 在 GameHelper.Core.csproj 中添加包引用

### 2. 测试 API 不匹配（阻塞所有测试）

**Gap**: 测试使用旧 API（string 参数），实现使用新 API（ProcessEventInfo 参数）
**Impact**: 所有现有测试无法运行
**Priority**: P0 - 必须立即修复
**Action**: 更新 IProcessMonitor 接口和所有测试 fakes

### 3. 完全缺少新功能测试

**Gap**: 所有 7 个验收标准都缺少测试覆盖
**Impact**: 无法验证功能正确性
**Priority**: P0 - 必须在发布前修复
**Action**: 添加完整测试套件（参见 test-design-20251110.md）

## Test Design Recommendations

详细的测试设计和实现指南请参见：
`docs/qa/assessments/1.2-test-design-20251110.md`

该文档包含：
- 18 个详细的测试场景
- 完整的测试代码示例
- 测试基础设施更新指南
- 推荐的测试执行顺序

## Risk Assessment

基于缺少的测试覆盖，识别以下风险：

1. **TECH-001 (高风险)**: 配置分组错误
   - 概率: 中
   - 影响: 高（导致匹配失败）
   - 缓解: 添加配置分组测试

2. **TECH-002 (高风险)**: L1/L2 流程控制错误
   - 概率: 中
   - 影响: 高（错误的匹配策略）
   - 缓解: 添加流程控制测试

3. **TECH-003 (中风险)**: 模糊匹配阈值不当
   - 概率: 低
   - 影响: 中（误匹配或漏匹配）
   - 缓解: 添加阈值边界测试

4. **TECH-004 (中风险)**: FileVersionInfo 异常未处理
   - 概率: 低
   - 影响: 中（L2 匹配失败）
   - 缓解: 添加异常处理测试

5. **PERF-001 (低风险)**: L2 匹配性能问题
   - 概率: 低
   - 影响: 低（轻微延迟）
   - 缓解: 添加性能基准测试

## Recommendations

### Immediate Actions (阻塞发布)

1. 添加 FuzzySharp 依赖
2. 更新 IProcessMonitor 接口
3. 重写所有现有测试
4. 添加 P0 测试覆盖（配置分组、L1/L2 匹配）

### Before Release (重要)

1. 添加完整的 18 个测试场景
2. 验证所有 AC 都有测试覆盖
3. 运行完整测试套件并确保通过
4. 更新文档（tech-stack.md）

### Future Improvements (可延后)

1. 添加性能基准测试
2. 添加集成测试
3. 添加压力测试
4. 添加监控指标

## Quality Gate Impact

由于完全缺少测试覆盖，此 Story 的质量门状态为：

**FAIL** - 必须修复所有高优先级问题才能通过质量门

详见：`docs/qa/gates/1.2-hybrid-matching-strategy.yml`
