# Story 1.1: 更新数据模型和配置加载（混合模式）

## Status

Done

## Story

**As a** 架构师,
**I want** 修改 `GameConfig` 模型以支持可选的 `ExecutablePath` 和必需的 `DataKey`,
**so that** 配置系统能同时处理新旧格式并确保数据关联完整性。

## Acceptance Criteria

1. `GameConfig.cs` 必须包含：`DataKey` (string, 必需), `ExecutablePath` (string, 可选), `ExecutableName` (string, 可选), `DisplayName` (string, 可选)。
2. `YamlConfigProvider.cs` 加载时必须要求 `DataKey` 存在，否则抛出错误。
3. `YamlConfigProvider.cs` 必须能成功加载同时包含 `ExecutablePath` 和 `ExecutableName` 的条目。
4. `YamlConfigProvider.cs` 加载只包含 `ExecutableName`（没有 `ExecutablePath`）的条目时，必须成功加载，并记录一个“警告”日志。

## Tasks / Subtasks

- [x] 更新 `GameHelper.Core/Models/GameConfig.cs` 数据模型结构以满足 AC1 (AC: 1)
  - [x] 定义属性注释/验证以明确可选与必选字段 (AC: 1)
- [x] 调整 `GameHelper.Infrastructure/Providers/YamlConfigProvider.cs` 解析逻辑 (AC: 2, 3, 4)
  - [x] 在配置加载流程中验证 `DataKey` 缺失并抛出明确异常 (AC: 2)
  - [x] 确保含 `ExecutablePath` 与 `ExecutableName` 的条目均可解析并持久化 (AC: 3)
  - [x] 为仅含 `ExecutableName` 的条目加载成功并输出警告日志 (AC: 4)
  - [x] 为新字段更新序列化/保存逻辑与默认模板 (AC: 1, 3, 4)
- [x] 新增或更新单元测试覆盖新增字段与验证逻辑 (AC: 2, 3, 4)
  - [x] 为缺失 `DataKey` 的配置抛错编写测试
  - [x] 为含路径/名称条目及仅名称条目的解析编写测试并断言日志行为
- [x] 根据 `docs/architecture/4-source-tree-and-module-organization.md` 校验文件位置与命名 (AC: 1-4)

## Dev Notes

### Previous Story Insights

无前置故事可引用。

### Data Models

- `GameConfig` 模型归属 `GameHelper.Core/Models/GameConfig.cs`，属性需覆盖 `DataKey`、`ExecutablePath`、`ExecutableName`、`DisplayName`，并保持与 CSV 持久化的 `DataKey` 一致性。[Source: architecture/5-data-models-and-storage.md#51-data-models]

### API Specifications

- 配置提供程序通过 YAML 解析器加载 `config.yml`，需确保新增字段保持现有序列化格式；无额外外部 API 依赖。

### Component Specifications

无 UI/组件更新要求。

### File Locations

- `GameHelper.Core/Models/GameConfig.cs` 定义数据模型。[Source: architecture/4-source-tree-and-module-organization.md#41-项目结构-实际]
- `GameHelper.Infrastructure/Providers/YamlConfigProvider.cs` 负责配置加载与验证，需在此实现 `DataKey` 校验与日志输出。[Source: architecture/4-source-tree-and-module-organization.md#42-关键模块及其用途]

### Testing Requirements

- 需添加针对 `GameAutomationService` 新匹配策略的单元测试，但本故事聚焦模型与配置，重点是验证配置加载逻辑及缺失字段异常。[Source: architecture/9-testing-status.md#91-current-test-coverage]
- 遵循现有 `GameHelper.Tests` 结构，在对应模块下补充单元测试，并确保 `dotnet test` 可直接覆盖新增测试。[Source: architecture/9-testing-status.md#92-running-tests]

### Technical Constraints

- 需保持与现有 `.NET 8` 运行环境与 `YamlDotNet` 解析器兼容，避免引入破坏性依赖变更。[Source: architecture/3-high-level-architecture.md#31-技术摘要]
- 新字段必须与后续故事中依赖的混合匹配逻辑保持兼容，确保 `DataKey` 为唯一必填项，为后续 `GameAutomationService` 分支逻辑奠定基础。[Source: architecture/6-功能排序与依赖.md#61-功能依赖]
- 保持 `config.yml` 回退兼容策略，允许旧配置继续加载（仅名称）并输出警告而非失败。[Source: architecture/3-high-level-architecture.md#31-技术摘要]

### Project Structure Notes

- 变更仅涉及 Core 模型与 Infrastructure 提供程序，符合文档中“配置管理”和“数据模型”所在位置的约束。[Source: architecture/4-source-tree-and-module-organization.md#42-关键模块及其用途]

### Testing

- 在 `GameHelper.Tests` 中扩展 `YamlConfigProviderTests`、`ConfigCommandTests` 等现有测试，覆盖 `DataKey` 校验、回退加载路径与 CLI 更新（新增断言 `DataKey`/`ExecutableName` 映射）。
- 运行 `dotnet test GameHelper.Tests/GameHelper.Tests.csproj --filter ConfigCommandTests`，验证目标测试用例通过并记录 WMI 空引用现有警告（与本故事无关）。
- 运行 `dotnet test GameHelper.Tests/GameHelper.Tests.csproj --filter YamlConfigProviderTests`（见前一阶段记录），确保配置提供程序的新增校验稳定。

## Change Log

| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2025-11-09 | 0.1     | 初始草稿   | Bob    |
| 2025-11-09 | 0.2     | 完成模型与配置提供程序改造，补充单元测试与 CLI/JSON 更新 | Dev Agent |

## Dev Agent Record

- **实现概述**：
  - 扩展 `GameConfig` 以引入 `DataKey`、`ExecutablePath`、`ExecutableName`、`DisplayName`，并保留 `Name`/`Alias` 兼容访问器。
  - 为 `YamlConfigProvider` / `JsonConfigProvider` 增加加载标准化、缺失字段回退及保存时的字段补全逻辑，同时引入日志警告。
  - 调整 `ConfigCommand` 与 `FileDropHandler` 创建条目时填充新字段，确保 CLI 操作与拖拽流程使用一致的键。
- **测试**：
  - 运行 `dotnet test GameHelper.Tests/GameHelper.Tests.csproj --filter ConfigCommandTests`（通过，存在既有 WMI 空引用警告）。
  - 运行 `dotnet test GameHelper.Tests/GameHelper.Tests.csproj --filter YamlConfigProviderTests`（通过）。
- **后续建议**：
  - 关注 `WmiProcessMonitor` 的空引用警告，在后续故事中统一处理。
  - 在集成测试中引入 `DataKey` 场景覆盖，验证 playtime 与自动化服务对新字段的消费路径。

## QA Results

- **Status**：PASS
- **Highlights**：
  1. `YamlConfigProvider` 现已对缺失 `DataKey` 的条目直接抛出 `InvalidDataException`，并在仅提供 `ExecutableName` 时记录警告，完全符合 AC2 与 AC4 要求 @GameHelper.Infrastructure/Providers/YamlConfigProvider.cs#167-225。
  2. `JsonConfigProvider` 同步执行严格的 `DataKey` 校验，消除存储介质差异并维持一致性 @GameHelper.Infrastructure/Providers/JsonConfigProvider.cs#140-191。
- **Test Evidence**：`dotnet test GameHelper.Tests/GameHelper.Tests.csproj --filter YamlConfigProviderTests`；`dotnet test GameHelper.Tests/GameHelper.Tests.csproj --filter ConfigCommandTests`（均通过）。
