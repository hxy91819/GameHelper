# Sprint 变更提案：修复 Story 1.2 模糊匹配缺陷

**提案日期：** 2025-11-11  
**提案人：** John (Product Manager)  
**影响范围：** Epic 1 - 混合匹配与 UI 增强  
**优先级：** 🔴 高（质量缺陷）

---

## 执行摘要

Story 1.2 的 L2 模糊匹配实现存在严重缺陷，导致系统工具（如 `reg.exe`、`rg.exe`）被错误匹配为游戏，污染用户数据。本提案通过创建 Story 1.7 来修复此问题，添加路径验证、动态阈值和黑名单机制，同时保持向后兼容性。

**关键指标：**
- 受影响故事：Story 1.2（已完成）
- 潜在影响：Story 1.3-1.6（需回归验证）
- 修复工作量：8-14 小时
- 风险等级：中等

---

## 1. 问题识别

### 1.1 触发故事
**Story 1.2: 更新核心匹配逻辑（混合策略）**  
状态：Done（但存在严重缺陷）

### 1.2 核心问题
L2 模糊匹配逻辑**仅基于文件名相似度**，未验证路径或文件长度，导致误匹配范围过大。

**实际案例：**
```
配置的游戏：RE.exe（极品采花郎）
路径：D:\Games\Romantic.Escapades.v2.0.2\game\RE.exe

错误匹配：
✗ reg.exe (score: 92) - Windows 注册表工具
✗ rg.exe (score: 83) - ripgrep 搜索工具
```

### 1.3 根本原因
1. **验收标准不完整**：Story 1.2 的 AC6 仅要求 "模糊匹配 > 80"，未要求路径验证
2. **短文件名问题**：2-4 字符的文件名，80 分阈值过于宽松
3. **缺少上下文验证**：未考虑文件所在目录、系统路径等辅助信息

### 1.4 影响评估
- **数据完整性**：用户游戏时长统计不准确
- **用户体验**：系统行为不可预测，降低信任度
- **后续故事风险**：Story 1.4（数据关联）和 1.5（历史迁移）可能基于错误匹配

---

## 2. Epic 影响分析

### 2.1 当前 Epic 状态
**Epic 1: 混合匹配与 UI 增强**

| Story | 状态 | 受影响程度 |
|-------|------|-----------|
| 1.1 | ✅ Done | 无影响 |
| 1.2 | ✅ Done | 🔴 **核心缺陷** |
| 1.3 | 📋 Ready for Review | 🟡 需回归验证 |
| 1.4 | 📋 Ready for Review | 🟡 需回归验证 |
| 1.5 | 📋 Ready for Review | 🟡 需回归验证 |
| 1.6 | 📋 Ready for Review | 🟡 需回归验证 |

### 2.2 Epic 可继续性
- ❌ **当前 Epic 无法安全发布** - Story 1.2 的缺陷会影响所有后续功能
- ⚠️ **Story 1.3-1.6 被阻塞** - 需要先修复 1.2，然后进行回归验证
- ⚠️ **数据完整性风险** - Story 1.4 和 1.5 依赖正确的匹配逻辑

### 2.3 未来 Epic 影响
- 无直接影响（假设未来 Epic 不依赖 Epic 1）
- 但如果不修复，会成为长期技术债务

---

## 3. 文档冲突分析

### 3.1 PRD 冲突
**文档：** `docs/prd/2-史诗和故事.md`

**Story 1.2 验收标准 AC6：**
> "如果模糊匹配（例如 `Fuzz.Ratio` > 80）成功，则匹配该配置。"

**问题：** 验收标准**未要求**路径验证或长度检查，导致实现符合 AC 但不符合实际需求。

**需要更新：** 添加安全边界要求到 AC6，或添加新的 AC7-AC9。

### 3.2 架构文档冲突
**文档：** `docs/architecture/tech-stack.md`

**当前描述：**
> "模糊匹配 | FuzzySharp | 2.0.2 | L2 回退匹配：ExecutableName + ProductName"

**问题：** 没有详细说明匹配的安全边界和验证机制。

**需要更新：** 添加安全机制说明（动态阈值、路径验证、黑名单）。

### 3.3 其他文档
- ✅ `docs/architecture/coding-standards.md` - 无冲突
- ✅ `docs/architecture/tech-stack.md` - 需要补充说明
- ⚠️ 用户文档 - 需要添加匹配行为说明

---

## 4. 前进路径评估

### 选项 1：紧急修复 + 回归测试（推荐）✅

**方案：** 创建 Story 1.7 修复核心问题，然后对 1.3-1.6 进行回归验证

**具体步骤：**
1. **立即修复 Story 1.2**（通过 Story 1.7）
   - 添加路径相关性验证
   - 实现动态阈值（基于文件名长度）
   - 添加系统路径黑名单
   - 增强日志记录
2. **回归测试 Story 1.3-1.6**
   - 验证拖放功能（1.3）不受影响
   - 验证数据关联（1.4）使用正确的 DataKey
   - 验证迁移工具（1.5）不会基于错误匹配迁移数据
   - 验证 ETW 监控（1.6）正常工作
3. **更新所有相关文档**
   - 更新 Story 1.2 的验收标准
   - 更新架构文档中的匹配策略说明
   - 添加用户文档说明匹配行为

**优点：**
- ✅ 保留所有已完成的工作
- ✅ 快速修复核心问题
- ✅ 通过回归测试确保整体质量
- ✅ 不需要重新开发 1.3-1.6

**缺点：**
- ⚠️ 需要仔细的回归测试
- ⚠️ 可能发现 1.3-1.6 中的连锁问题

**工作量估算：**
- 修复实现：4-6 小时
- 单元测试：2-3 小时
- 回归测试：4-8 小时
- 文档更新：1-2 小时
- **总计：11-19 小时**

**风险评估：** 🟡 中等
- 如果 1.3-1.6 没有依赖错误匹配的逻辑，风险较低
- 如果有依赖，需要额外修复

---

### 选项 2：回滚到 Story 1.1 + 重做 Epic 1

**方案：** 回滚所有 1.2-1.6，重新设计和实现

**优点：**
- ✅ 可以从头设计完美的方案

**缺点：**
- ❌ 浪费大量已完成的工作（5 个故事）
- ❌ 严重延迟项目进度（估计 40-80 小时）
- ❌ 团队士气打击

**工作量估算：** 40-80 小时

**风险评估：** 🔴 高 - **不推荐**

---

### 选项 3：接受风险 + 添加配置选项

**方案：** 保持现状，添加配置选项让用户控制匹配行为

**优点：**
- ✅ 不需要修改核心代码
- ✅ 给用户更多控制权

**缺点：**
- ❌ 默认行为仍然不安全
- ❌ 把问题推给用户
- ❌ 不符合"安全默认"原则

**工作量估算：** 2-4 小时

**风险评估：** 🔴 高 - **不推荐**

---

## 5. 推荐路径：选项 1

### 5.1 推荐理由
1. ✅ Story 1.2 的核心实现是正确的，只是缺少安全边界
2. ✅ 问题可以通过增量修复解决，不需要推倒重来
3. ✅ 不会阻塞后续故事的开发
4. ✅ 符合敏捷原则：快速迭代，持续改进
5. ✅ 保护已投入的工作成果

### 5.2 实施计划

#### 阶段 1：创建 Story 1.7（已完成）✅
- ✅ 故事文档已创建：`docs/stories/1.7.enhance-fuzzy-matching-safety.md`
- ✅ 包含详细的验收标准、实现指导和测试策略

#### 阶段 2：实施修复（预计 4-6 小时）
**任务清单：**
- [ ] 实现 `CalculateFuzzyThreshold()` 方法
- [ ] 实现 `IsPathRelated()` 方法
- [ ] 实现 `IsSystemPath()` 方法
- [ ] 更新 `TryMatchByMetadata()` 方法
- [ ] 添加详细日志记录

#### 阶段 3：测试验证（预计 6-11 小时）
**单元测试：**
- [ ] 动态阈值边界测试（94/95, 89/90, 79/80）
- [ ] 路径相关性验证测试
- [ ] 系统路径黑名单测试
- [ ] 旧配置兼容性测试

**回归测试：**
- [ ] 验证 `reg.exe` 不再匹配 `RE.exe`
- [ ] 验证 `rg.exe` 不再匹配 `RE.exe`
- [ ] 验证合法的 `RE.exe` 仍然匹配
- [ ] 运行完整测试套件

**Story 1.3-1.6 回归验证：**
- [ ] Story 1.3（拖放）：功能正常
- [ ] Story 1.4（数据关联）：DataKey 正确
- [ ] Story 1.5（迁移工具）：迁移逻辑正确
- [ ] Story 1.6（ETW 默认）：监控正常

#### 阶段 4：文档更新（预计 1-2 小时）
- [ ] 更新 Story 1.2 验收标准（添加修复说明）
- [ ] 更新 `docs/architecture/tech-stack.md`
- [ ] 添加用户文档说明匹配行为
- [ ] 更新技术债务记录（如果需要）

### 5.3 成功标准
- ✅ `reg.exe` 和 `rg.exe` 不再错误匹配 `RE.exe`
- ✅ 合法的游戏配置仍然正常工作
- ✅ 所有单元测试通过
- ✅ Story 1.3-1.6 回归测试通过
- ✅ 文档完整更新

---

## 6. 风险管理

### 6.1 已识别风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| Story 1.3-1.6 依赖错误匹配 | 低 | 高 | 详细回归测试 |
| 新验证逻辑引入新 bug | 中 | 中 | 全面单元测试 |
| 旧配置兼容性破坏 | 低 | 高 | 专项兼容性测试 |
| 性能下降 | 低 | 低 | 性能基准测试 |

### 6.2 回滚计划
如果修复导致严重问题：
1. 可以通过配置选项临时禁用新的安全检查
2. 回滚到 Story 1.2 的实现
3. 重新评估安全策略

---

## 7. 时间线

| 阶段 | 预计时间 | 负责人 |
|------|---------|--------|
| Story 1.7 创建 | ✅ 已完成 | John (PM) |
| 实施修复 | 4-6 小时 | Dev Agent |
| 单元测试 | 2-3 小时 | Dev Agent |
| 回归测试 | 4-8 小时 | QA Agent |
| 文档更新 | 1-2 小时 | PM/Dev |
| **总计** | **11-19 小时** | - |

---

## 8. 利益相关者沟通

### 8.1 需要通知的角色
- ✅ **Dev Agent (James)** - 实施修复
- ✅ **QA Agent (Quinn)** - 回归测试
- ✅ **PO Agent (Sarah)** - 验收确认
- ✅ **用户** - 说明修复内容和影响

### 8.2 沟通要点
- 这是一个**质量缺陷修复**，不是新功能
- 修复会提高匹配准确性，避免误匹配
- 旧配置仍然兼容，不需要用户手动迁移
- 修复后需要重新测试 Story 1.3-1.6

---

## 9. 批准和下一步

### 9.1 提案状态
- [x] 问题分析完成
- [x] 解决方案设计完成
- [x] Story 1.7 文档创建
- [ ] 用户批准
- [ ] 开始实施

### 9.2 批准签字
- **Product Manager (John):** ✅ 已批准
- **用户:** ⏳ 待批准

### 9.3 下一步行动
1. **用户批准本提案**
2. **Dev Agent 开始实施 Story 1.7**
3. **QA Agent 准备回归测试计划**
4. **完成后更新 Story 1.2 状态**

---

## 附录

### A. Story 1.7 文档位置
`docs/stories/1.7.enhance-fuzzy-matching-safety.md`

### B. 相关文档
- Story 1.2: `docs/stories/1.2.hybrid-matching-strategy.md`
- PRD Epic 1: `docs/prd/2-史诗和故事.md`
- 架构文档: `docs/architecture/tech-stack.md`
- QA Gate: `docs/qa/gates/1.2-hybrid-matching-strategy.yml`

### C. 技术参考
- FuzzySharp 文档: https://github.com/JakeBayer/FuzzySharp
- .NET Path API: https://learn.microsoft.com/en-us/dotnet/api/system.io.path

---

**提案结束**

如有任何问题或需要澄清，请联系 Product Manager (John)。
